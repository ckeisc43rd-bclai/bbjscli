<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全屏終端界面</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ansi_up/5.0.1/ansi_up.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #terminal-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: black;
            color: white;
            font-family: monospace;
        }
        #terminal {
            flex-grow: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 10px;
        }
        #input-area {
            width: 100%;
            background-color: black;
            color: white;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="terminal-container">
        <div id="terminal"></div>
        <input type="text" id="input-area" placeholder="輸入指令...">
    </div>

    <script type="module" type="text/javascript">
        import { AnsiUp } from './ansi_up.js'
        const terminal = document.getElementById('terminal');
        const inputArea = document.getElementById('input-area');
        let ws;
        const ansiUp = new AnsiUp();

        function connect() {
            ws = new WebSocket('ws://localhost:3000');

            ws.onopen = () => {
                appendToTerminal('已連接到伺服器\n');
            };

            ws.onmessage = (event) => {
                const data = event.data;
                handleServerMessage(data);
            };

            ws.onclose = () => {
                appendToTerminal('與伺服器的連接已關閉\n');
            };
        }

        function handleServerMessage(data) {
            const html = ansiUp.ansi_to_html(data);
            appendToTerminal(html);
        }

        function appendToTerminal(html) {
            terminal.innerHTML += html;
            terminal.scrollTop = terminal.scrollHeight;
        }

        inputArea.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const input = inputArea.value + '\n';
                ws.send(input);
                inputArea.value = '';
            } else if (event.ctrlKey) {
                const ctrlChar = String.fromCharCode(event.keyCode).toLowerCase();
                ws.send(String.fromCharCode(ctrlChar.charCodeAt(0) - 96));
                event.preventDefault();
            } else if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                const arrowKeyCodes = {
                    'ArrowUp': '\x1b[A',
                    'ArrowDown': '\x1b[B',
                    'ArrowRight': '\x1b[C',
                    'ArrowLeft': '\x1b[D'
                };
                ws.send(arrowKeyCodes[event.key]);
                event.preventDefault();
            }
        });

        // 初始連接
        connect();

        // 自動聚焦到輸入區域
        inputArea.focus();
    </script>
</body>
</html>